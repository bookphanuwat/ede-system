const API_URL="api/manage_workflow.php";let allWorkflows=[];function disableSubmit(){const btn=document.getElementById("btnSubmit"),preview=document.getElementById("statusPreview");btn.classList.add("btn-disabled-custom"),btn.removeAttribute("style"),preview.innerHTML='<i class="fas fa-arrow-right"></i> สถานะเริ่มต้น: <span class="text-secondary">-</span>',document.getElementById("initialStatusInput").value=""}function loadWorkflows(){const select=document.getElementById("workflowSelect");select.innerHTML='<option value="" disabled selected>กำลังโหลดข้อมูล...</option>';const userId="undefined"!=typeof CURRENT_USER_ID?CURRENT_USER_ID:"";fetch(`${API_URL}?action=list&user_id=${userId}`).then(res=>res.json()).then(res=>{select.innerHTML='<option value="" selected disabled>-- กรุณาเลือกหมวดหมู่สถานะ --</option>',res.success&&res.data.length>0?(allWorkflows=res.data,res.data.forEach(cat=>{const option=document.createElement("option");option.value=cat.id,option.textContent=cat.name,select.appendChild(option)})):select.innerHTML='<option value="" disabled>ไม่พบข้อมูล (ต้องสร้างหมวดหมู่ก่อน)</option>'}).catch(err=>{console.error(err),select.innerHTML='<option value="" disabled>Error loading workflows</option>'})}document.addEventListener("DOMContentLoaded",(function(){loadWorkflows(),document.getElementById("workflowSelect").addEventListener("change",(function(){const selectedId=this.value,submitBtn=document.getElementById("btnSubmit"),statusPreview=document.getElementById("statusPreview"),initialStatusInput=document.getElementById("initialStatusInput"),workflowIdInput=document.getElementById("workflowIdInput");if(selectedId){const selectedCat=allWorkflows.find(cat=>cat.id===selectedId);if(selectedCat&&selectedCat.statuses.length>0){submitBtn.classList.remove("btn-disabled-custom"),submitBtn.style.backgroundColor="#00E676",submitBtn.style.color="black";const firstStatus=selectedCat.statuses[0];initialStatusInput.value=firstStatus.name,workflowIdInput.value=selectedCat.id,statusPreview.innerHTML=`<i class="fas fa-check-circle text-success"></i> สถานะเริ่มต้น: <span class="badge bg-${firstStatus.color}">${firstStatus.name}</span>`}else alert("หมวดหมู่นี้ยังไม่มีการกำหนดสถานะ (Workflow ว่างเปล่า) กรุณาไปตั้งค่าก่อน"),this.value="",disableSubmit()}else disableSubmit()}))}));