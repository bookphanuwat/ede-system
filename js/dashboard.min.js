function showQRModal(docCode,docTitle){document.getElementById("modalDocCode").innerText="รหัส: "+docCode,document.getElementById("modalDocTitle").innerText=docTitle,document.getElementById("btnPrintLink").href="../print/"+docCode;const qrContainer=document.getElementById("qrcode");qrContainer.innerHTML="","undefined"!=typeof QRCode&&new QRCode(qrContainer,{text:docCode,width:180,height:180});const qrModal=new bootstrap.Modal(document.getElementById("qrModal"));qrModal.show()}async function openDetailModal(code){const detailModal=new bootstrap.Modal(document.getElementById("detailModal"));detailModal.show(),document.getElementById("modalLoading").style.display="block",document.getElementById("modalContent").style.display="none";try{const res=await fetch(`${site_url}/api/getdocinfo/${code}/`),data=await res.json();if(data.error)throw new Error(data.error);const doc=data.doc;document.getElementById("d_title").innerText=doc.title,document.getElementById("d_code").innerText=doc.document_code,document.getElementById("d_status").innerText=doc.current_status,document.getElementById("d_type").innerText=doc.type_name||"-",document.getElementById("d_date").innerText=doc.created_at,document.getElementById("d_sender").innerText=doc.sender_name,document.getElementById("d_receiver").innerText=doc.receiver_name;const viewsElement=document.getElementById("d_views");viewsElement&&(viewsElement.innerText=doc.view_count||0);let html="";data.logs&&data.logs.length>0?data.logs.forEach((log,index)=>{const activeClass=0===index?"active":"",actor=log.actor_name_snapshot||log.fullname||"Unknown",actorPic=log.actor_pic_snapshot?`<img src="${log.actor_pic_snapshot}" class="rounded-circle me-1" width="20">`:'<i class="fas fa-user-circle me-1"></i>';html+=`\n                    <div class="timeline-item">\n                        <div class="timeline-dot ${activeClass}"></div>\n                        <div class="ps-4">\n                            <div class="d-flex justify-content-between">\n                                <strong class="text-dark">${log.status}</strong>\n                                <small class="text-muted">${log.action_time}</small>\n                            </div>\n                            <small class="text-secondary d-flex align-items-center mt-1">\n                                โดย: ${actorPic} ${actor}\n                            </small>\n                            ${log.location_note?`<br><small class="text-danger"><i class="fas fa-map-marker-alt"></i> ${log.location_note}</small>`:""}\n                        </div>\n                    </div>`}):html='<p class="text-muted ms-4">ยังไม่มีประวัติ</p>',document.getElementById("d_timeline").innerHTML=html,document.getElementById("modalLoading").style.display="none",document.getElementById("modalContent").style.display="block"}catch(err){alert("ไม่สามารถโหลดข้อมูลได้: "+err.message)}}window.addEventListener("load",(function(){const navTiming=performance.getEntriesByType("navigation")[0],serverTimeMs="undefined"!=typeof SERVER_TIME_MS?SERVER_TIME_MS:0,clientRenderTime=navTiming?navTiming.domInteractive-navTiming.fetchStart:0,totalLoadTime=(performance.now()/1e3).toFixed(3),loadTimeElement=document.getElementById("loadTime");loadTimeElement&&(loadTimeElement.textContent=totalLoadTime)}));