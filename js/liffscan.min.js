var API_BASE="undefined"!=typeof site_url?site_url:".",MY_LIFF_ID="2008591805-LlbR2M99",userProfile={userId:"",displayName:"Guest",pictureUrl:""},currentDocCode="",currentDocWorkflowId="cat_default";async function main(){try{if(await liff.init({liffId:MY_LIFF_ID}),!liff.isLoggedIn())return void liff.login();userProfile=await liff.getProfile();var imgEl=document.getElementById("userImg"),nameEl=document.getElementById("userName");imgEl&&userProfile.pictureUrl&&(imgEl.src=userProfile.pictureUrl),nameEl&&userProfile.displayName&&(nameEl.innerText=userProfile.displayName)}catch(err){console.error("LIFF Init Error:",err)}}function setupEventListeners(){var searchArea=document.getElementById("searchResultArea");searchArea&&searchArea.addEventListener("click",(function(e){var card=e.target.closest(".search-card");if(card){var code=card.getAttribute("data-code");code&&loadDocDetail(code,!1)}}));var historyArea=document.getElementById("historyListArea");historyArea&&historyArea.addEventListener("click",(function(e){var card=e.target.closest(".history-card");if(card){var code=card.getAttribute("data-code");code&&loadDocDetail(code,!1)}}));var scanBtn=document.getElementById("btn-scan");scanBtn&&scanBtn.addEventListener("click",openLineScanner);var searchBtn=document.getElementById("btn-search");searchBtn&&searchBtn.addEventListener("click",searchDocs);var closeDetailBtn=document.getElementById("btn-close-detail");closeDetailBtn&&closeDetailBtn.addEventListener("click",closeDetail);var openUpdateBtn=document.getElementById("btn-open-update");openUpdateBtn&&openUpdateBtn.addEventListener("click",openUpdateModal);var tabScan=document.getElementById("tab-btn-scan");tabScan&&tabScan.addEventListener("click",(function(){switchTab("scan")}));var tabSearch=document.getElementById("tab-btn-search");tabSearch&&tabSearch.addEventListener("click",(function(){switchTab("search")}));var tabHistory=document.getElementById("tab-btn-history");tabHistory&&tabHistory.addEventListener("click",(function(){switchTab("history")}))}function switchTab(tabName){for(var pages=document.querySelectorAll(".page-section"),i=0;i<pages.length;i++)pages[i].classList.remove("active");var targetPage=document.getElementById("tab-"+tabName);targetPage&&targetPage.classList.add("active");for(var navItems=document.querySelectorAll(".nav-item"),j=0;j<navItems.length;j++)navItems[j].classList.remove("active");var activeBtn=null;"scan"===tabName?activeBtn=document.getElementById("tab-btn-scan"):"search"===tabName?activeBtn=document.getElementById("tab-btn-search"):"history"===tabName&&(activeBtn=document.getElementById("tab-btn-history")),activeBtn&&activeBtn.classList.add("active"),"history"===tabName&&loadHistory()}async function openLineScanner(){if(liff.isInClient()&&"web"!==liff.getOS())try{const result=await liff.scanCodeV2();result.value&&loadDocDetail(result.value,!0)}catch(err){console.error("Scan Error:",err)}else Swal.fire({icon:"error",title:"ไม่รองรับ",text:"ฟีเจอร์นี้ใช้งานได้เฉพาะบนแอป LINE ในมือถือเท่านั้น"})}async function searchDocs(){var searchInput=document.getElementById("searchInput");if(searchInput){var keyword=searchInput.value,resultArea=document.getElementById("searchResultArea");if(keyword){resultArea.innerHTML='<div class="text-center mt-3"><i class="fas fa-spinner fa-spin"></i> กำลังค้นหา...</div>';try{const res=await fetch(API_BASE+"/api/index.php?dev=search&keyword="+encodeURIComponent(keyword)),json=await res.json();var html="";json.data&&json.data.length>0?json.data.forEach((function(doc){html+=`<div class="search-card" data-code="${doc.document_code}" style="cursor:pointer; padding:10px; border-bottom:1px solid #eee;">\n                                <div class="fw-bold">${doc.title}</div>\n                                <small class="text-muted">${doc.document_code}</small>\n                                <span class="badge bg-light text-dark float-end">${doc.current_status}</span>\n                             </div>`})):html='<p class="text-center text-muted mt-3">ไม่พบข้อมูล</p>',resultArea.innerHTML=html}catch(err){console.error(err),resultArea.innerHTML='<p class="text-center text-danger">เกิดข้อผิดพลาด</p>'}}}}async function loadHistory(){try{var resultArea=document.getElementById("historyListArea");const res=await fetch(API_BASE+"/api/index.php?dev=history&line_id="+userProfile.userId),json=await res.json();var html="";json.data&&json.data.length>0?json.data.forEach((function(log){html+=`<div class="history-card status-${log.status}" data-code="${log.document_code}" style="cursor:pointer; padding:10px; border-bottom:1px solid #eee;">\n                            <div class="d-flex justify-content-between">\n                                <span class="fw-bold text-dark">${log.status}</span>\n                                <small class="text-muted">${log.action_time}</small>\n                            </div>\n                            <small class="d-block text-truncate">${log.title}</small>\n                         </div>`})):html='<p class="text-center text-muted mt-5">ยังไม่มีประวัติการสแกน</p>',resultArea.innerHTML=html}catch(err){console.error(err)}}async function loadDocDetail(code,fromScanner){void 0===fromScanner&&(fromScanner=!1),currentDocCode=code,fromScanner||Swal.fire({title:"Loading...",didOpen:function(){Swal.showLoading()}});try{var url=API_BASE+"/api/getdocinfo/"+code+"/";fromScanner&&(url+="?action=scan",url+="&line_id="+encodeURIComponent(userProfile.userId||""),url+="&name="+encodeURIComponent(userProfile.displayName||"Guest"),url+="&pic="+encodeURIComponent(userProfile.pictureUrl||""));const res=await fetch(url),json=await res.json();if(json.error)throw new Error(json.error);const doc=json.doc;currentDocWorkflowId=doc.workflow_id||"cat_default",document.getElementById("detailTitle")&&(document.getElementById("detailTitle").innerText=doc.title),document.getElementById("detailCode")&&(document.getElementById("detailCode").innerText=doc.document_code),document.getElementById("detailStatus")&&(document.getElementById("detailStatus").innerHTML=doc.current_status),document.getElementById("detailViews")&&(document.getElementById("detailViews").innerText=doc.view_count);var receiverName=doc.receiver_name||"-";document.getElementById("detailReceiver")&&(document.getElementById("detailReceiver").innerText=receiverName);var timelineHtml="";json.logs&&json.logs.forEach((function(log){var actor=log.actor_name_snapshot||log.fullname||"Unknown",borderClass="Received"===log.status?"border-success":"border-warning";timelineHtml+=`<div class="mb-3 ps-3 border-start border-3 ${borderClass}">\n                                    <div class="fw-bold text-dark">${log.status}</div>\n                                    <small class="text-muted">${log.action_time}</small><br>\n                                    <small>โดย: ${actor}</small>\n                                 </div>`})),document.getElementById("detailTimeline")&&(document.getElementById("detailTimeline").innerHTML=timelineHtml),Swal.close();var overlay=document.getElementById("detailOverlay");overlay&&(overlay.style.display="block")}catch(err){Swal.fire("Error","ไม่พบข้อมูลเอกสาร หรือ "+err.message,"error")}}function closeDetail(){var overlay=document.getElementById("detailOverlay");overlay&&(overlay.style.display="none")}async function openUpdateModal(){var statusOptions="";try{const res=await fetch(API_BASE+"/api/index.php?dev=get-statuses&workflow_id="+currentDocWorkflowId),json=await res.json();if("success"===json.status&&json.data.length>0){var currentCategory="";json.data.forEach((function(s){s.category!==currentCategory&&(""!==currentCategory&&(statusOptions+="</optgroup>"),statusOptions+=`<optgroup label="${s.category}">`,currentCategory=s.category),statusOptions+=`<option value="${s.status_name}">${s.status_name}</option>`})),""!==currentCategory&&(statusOptions+="</optgroup>")}else statusOptions='<option value="Received">ได้รับแล้ว</option><option value="Sent">ส่งต่อ</option>'}catch(e){console.error("Fetch Status Error:",e),statusOptions='<option value="Received">ได้รับแล้ว</option><option value="Sent">ส่งต่อ</option>'}const swalResult=await Swal.fire({title:"อัปเดตสถานะ",html:`<div class="text-start">\n                 <label for="swal-status" class="form-label">เลือกสถานะ:</label>\n                 <select id="swal-status" name="status_update" class="form-select mb-3">${statusOptions}</select>\n               \n                 <label for="swal-receiver" class="form-label">*หมายเหตุ (ถ้ามี):</label>\n                 <input id="swal-receiver" name="note_update" class="form-control" placeholder="ระบุหมายเหตุ">\n               </div>`,focusConfirm:!1,showCancelButton:!0,confirmButtonText:"บันทึก",confirmButtonColor:"#00C853",preConfirm:function(){return[document.getElementById("swal-status").value,document.getElementById("swal-receiver").value]}});if(swalResult.value){var status=swalResult.value[0],receiver=swalResult.value[1],payload={doc_code:currentDocCode,status:status,receiver_name:receiver,line_user_id:userProfile.userId,display_name:userProfile.displayName,picture_url:userProfile.pictureUrl,device_info:liff.getOS()};await fetch(API_BASE+"/api/index.php?dev=update-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}),Swal.fire({title:"สำเร็จ",text:"บันทึกข้อมูลเรียบร้อยแล้ว",icon:"success",timer:1500,showConfirmButton:!1}).then((function(){closeDetail()}))}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(function(){setupEventListeners(),main()})):(setupEventListeners(),main());