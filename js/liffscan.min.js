const MY_LIFF_ID="2008591805-LlbR2M99";let userProfile={userId:"",displayName:"Guest",pictureUrl:""},currentDocCode="",currentDocWorkflowId="cat_default";const originalFetch=window.fetch;async function main(){try{if(await liff.init({liffId:MY_LIFF_ID}),!liff.isLoggedIn())return void liff.login();userProfile=await liff.getProfile(),document.getElementById("userImg")&&(document.getElementById("userImg").src=userProfile.pictureUrl),document.getElementById("userName")&&(document.getElementById("userName").innerText=userProfile.displayName),liff.isInClient()||Swal.fire("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô","‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô LINE ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå","warning")}catch(err){console.error("LIFF Init Error:",err),Swal.fire("Error","LIFF Init Failed: "+err,"error")}}async function openLineScanner(){if(liff.isInClient()&&"web"!==liff.getOS())try{const result=await liff.scanCodeV2();result.value&&loadDocDetail(result.value,!0)}catch(err){console.error("Scan Error:",err)}else Swal.fire({icon:"error",title:"‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö",text:"‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏ô‡πÅ‡∏≠‡∏õ LINE ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"})}function switchTab(tabName){document.querySelectorAll(".page-section").forEach(el=>el.classList.remove("active")),document.querySelectorAll(".nav-item").forEach(el=>el.classList.remove("active")),document.getElementById("tab-"+tabName).classList.add("active"),event&&event.currentTarget&&event.currentTarget.classList.add("active"),"scan"===tabName?openLineScanner():"history"===tabName&&loadHistory()}async function searchDocs(){const keyword=document.getElementById("searchInput").value;if(keyword){document.getElementById("searchResultArea").innerHTML='<div class="text-center mt-3"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</div>';try{const res=await fetch(`${site_url}/api/index.php?dev=search&keyword=${keyword}`),json=await res.json();let html="";json.data&&json.data.length>0?json.data.forEach(doc=>{html+=`<div class="search-card" onclick="loadDocDetail('${doc.document_code}', false)">\n                                <div class="fw-bold">${doc.title}</div>\n                                <small class="text-muted">${doc.document_code}</small>\n                                <span class="badge bg-light text-dark float-end">${doc.current_status}</span>\n                             </div>`}):html='<p class="text-center text-muted mt-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>',document.getElementById("searchResultArea").innerHTML=html}catch(err){console.error(err),document.getElementById("searchResultArea").innerHTML='<p class="text-center text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>'}}}async function loadHistory(){try{const res=await fetch(`${site_url}/api/index.php?dev=history&line_id=${userProfile.userId}`),json=await res.json();let html="";json.data&&json.data.length>0?json.data.forEach(log=>{html+=`<div class="history-card status-${log.status}" onclick="loadDocDetail('${log.document_code}', false)">\n                            <div class="d-flex justify-content-between">\n                                <span class="fw-bold text-dark">${log.status}</span>\n                                <small class="text-muted">${log.action_time}</small>\n                            </div>\n                            <small class="d-block text-truncate">${log.title}</small>\n                         </div>`}):html='<p class="text-center text-muted mt-5">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</p>',document.getElementById("historyListArea").innerHTML=html}catch(err){console.error(err)}}async function loadDocDetail(code,fromScanner=!1){currentDocCode=code,fromScanner||Swal.fire({title:"Loading...",didOpen:()=>Swal.showLoading()});try{let url=`${site_url}/api/getdocinfo/${code}/`;fromScanner&&(url+="?action=scan");const res=await fetch(url),json=await res.json();if(json.error)throw new Error(json.error);const doc=json.doc;currentDocWorkflowId=doc.workflow_id||"cat_default",document.getElementById("detailTitle").innerText=doc.title,document.getElementById("detailCode").innerText=doc.document_code,document.getElementById("detailStatus").innerHTML=`${doc.current_status} <span class="badge bg-light text-dark ms-2">üëÅÔ∏è ${doc.view_count}</span>`,document.getElementById("detailReceiver").innerText=doc.receiver_name||"-";let timelineHtml="";json.logs&&json.logs.forEach(log=>{const actor=log.actor_name_snapshot||log.fullname||"Unknown";timelineHtml+=`<div class="mb-3 ps-3 border-start border-3 ${"Received"===log.status?"border-success":"border-warning"}">\n                                    <div class="fw-bold text-dark">${log.status}</div>\n                                    <small class="text-muted">${log.action_time}</small><br>\n                                    <small>‡πÇ‡∏î‡∏¢: ${actor}</small>\n                                 </div>`}),document.getElementById("detailTimeline").innerHTML=timelineHtml,Swal.close(),document.getElementById("detailOverlay").style.display="block"}catch(err){Swal.fire("Error","‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ "+err.message,"error")}}function closeDetail(){document.getElementById("detailOverlay").style.display="none"}async function openUpdateModal(){let statusOptions="";try{const res=await fetch(`${site_url}/api/index.php?dev=get-statuses&workflow_id=${currentDocWorkflowId}`),json=await res.json();if("success"===json.status&&json.data.length>0){let currentCategory="";json.data.forEach(s=>{s.category!==currentCategory&&(""!==currentCategory&&(statusOptions+="</optgroup>"),statusOptions+=`<optgroup label="${s.category}">`,currentCategory=s.category),statusOptions+=`<option value="${s.status_name}">${s.status_name}</option>`}),""!==currentCategory&&(statusOptions+="</optgroup>")}else statusOptions='<option value="Received">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option><option value="Sent">‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</option>'}catch(e){console.error("Fetch Status Error:",e),statusOptions='<option value="Received">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option><option value="Sent">‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</option>'}const{value:formValues}=await Swal.fire({title:"‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",html:`<label class="form-label text-start w-100">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>\n               <select id="swal-status" class="form-select mb-3">${statusOptions}</select>`+'<label class="form-label text-start w-100">*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>\n               <input id="swal-receiver" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏">',focusConfirm:!1,showCancelButton:!0,confirmButtonText:"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",confirmButtonColor:"#00C853",preConfirm:()=>[document.getElementById("swal-status").value,document.getElementById("swal-receiver").value]});if(formValues){const[status,receiver]=formValues,payload={doc_code:currentDocCode,status:status,receiver_name:receiver,line_user_id:userProfile.userId,display_name:userProfile.displayName,picture_url:userProfile.pictureUrl,device_info:liff.getOS()};await fetch(`${site_url}/api/index.php?dev=update-status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}),Swal.fire({title:"‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",text:"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",icon:"success",timer:1500,showConfirmButton:!1}).then(()=>{closeDetail()})}}window.fetch=function(url,options){return url&&url.toString().startsWith("https://liffsdk.line-scdn.net/xlt/")&&url.toString().endsWith(".json")&&(console.log("Bypassing LIFF Cache:",url),url=url+"?ts="+Math.random()),originalFetch(url,options)},main();