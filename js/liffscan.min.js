var API_BASE="undefined"!=typeof site_url?site_url:".",MY_LIFF_ID="2008591805-LlbR2M99",userProfile={userId:"",displayName:"Guest",pictureUrl:""},currentDocCode="",currentDocWorkflowId="cat_default",originalFetch=window.fetch;window.fetch=function(e,t){return e&&e.toString().startsWith("https://liffsdk.line-scdn.net/xlt/")&&e.toString().endsWith(".json")&&(e+="?ts="+Math.random()),originalFetch(e,t)};async function main(){try{if(await liff.init({liffId:MY_LIFF_ID}),!liff.isLoggedIn())return void liff.login();userProfile=await liff.getProfile();var e=document.getElementById("userImg"),t=document.getElementById("userName");e&&userProfile.pictureUrl&&(e.src=userProfile.pictureUrl),t&&(t.innerText=userProfile.displayName||"Guest"),liff.isInClient()||Swal.fire("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô","‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô LINE ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå","warning")}catch(e){console.error("LIFF Init Error:",e);var n=document.getElementById("userName");n&&(n.innerText="Guest (Error)")}}async function openLineScanner(){if(liff.isInClient()&&"web"!==liff.getOS())try{const e=await liff.scanCodeV2();e.value&&loadDocDetail(e.value,!0)}catch(e){console.error("Scan Error:",e)}else Swal.fire({icon:"error",title:"‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö",text:"‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏ô‡πÅ‡∏≠‡∏õ LINE ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"})}function switchTab(e){document.querySelectorAll(".page-section").forEach((e=>e.classList.remove("active"))),document.querySelectorAll(".nav-item").forEach((e=>e.classList.remove("active"))),document.getElementById("tab-"+e).classList.add("active");var t=document.getElementById("tab-btn-"+e);t&&t.classList.add("active"),"scan"===e?openLineScanner():"history"===e&&loadHistory()}async function searchDocs(){const e=document.getElementById("searchInput").value;if(e){document.getElementById("searchResultArea").innerHTML='<div class="text-center mt-3"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</div>';try{const t=await fetch(`${API_BASE}/api/index.php?dev=search&keyword=${encodeURIComponent(e)}`),n=await t.json();let a="";n.data&&n.data.length>0?n.data.forEach((e=>{a+=`<div class="search-card" onclick="loadDocDetail('${e.document_code}', false)"><div class="fw-bold">${e.title}</div><small class="text-muted">${e.document_code}</small><span class="badge bg-light text-dark float-end">${e.current_status}</span></div>`})):a='<p class="text-center text-muted mt-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>',document.getElementById("searchResultArea").innerHTML=a}catch(e){console.error(e),document.getElementById("searchResultArea").innerHTML='<p class="text-center text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>'}}}async function loadHistory(){try{const e=await fetch(`${API_BASE}/api/index.php?dev=history&line_id=${userProfile.userId}`),t=await e.json();let n="";t.data&&t.data.length>0?t.data.forEach((e=>{n+=`<div class="history-card status-${e.status}" onclick="loadDocDetail('${e.document_code}', false)"><div class="d-flex justify-content-between"><span class="fw-bold text-dark">${e.status}</span><small class="text-muted">${e.action_time}</small></div><small class="d-block text-truncate">${e.title}</small></div>`})):n='<p class="text-center text-muted mt-5">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</p>',document.getElementById("historyListArea").innerHTML=n}catch(e){console.error(e)}}async function loadDocDetail(e,t=!1){currentDocCode=e,t||Swal.fire({title:"Loading...",didOpen:()=>Swal.showLoading()});try{let n=`${API_BASE}/api/getdocinfo/${e}/`;t&&(n+="?action=scan",n+=`&line_id=${encodeURIComponent(userProfile.userId||"")}`,n+=`&name=${encodeURIComponent(userProfile.displayName||"Guest")}`,n+=`&pic=${encodeURIComponent(userProfile.pictureUrl||"")}`);const a=await fetch(n),r=await a.json();if(r.error)throw new Error(r.error);const i=r.doc;currentDocWorkflowId=i.workflow_id||"cat_default",document.getElementById("detailTitle").innerText=i.title,document.getElementById("detailCode").innerText=i.document_code,document.getElementById("detailStatus").innerHTML=`${i.current_status} <span class="badge bg-light text-dark ms-2">üëÅÔ∏è ${i.view_count}</span>`,document.getElementById("detailReceiver").innerText=i.receiver_name||"-";let c="";r.logs&&r.logs.forEach((e=>{const t=e.actor_name_snapshot||e.fullname||"Unknown";c+=`<div class="mb-3 ps-3 border-start border-3 ${"Received"===e.status?"border-success":"border-warning"}"><div class="fw-bold text-dark">${e.status}</div><small class="text-muted">${e.action_time}</small><br><small>‡πÇ‡∏î‡∏¢: ${t}</small></div>`})),document.getElementById("detailTimeline").innerHTML=c,Swal.close(),document.getElementById("detailOverlay").style.display="block"}catch(e){Swal.fire("Error","‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ "+e.message,"error")}}function closeDetail(){document.getElementById("detailOverlay").style.display="none"}async function openUpdateModal(){let e="";try{const t=await fetch(`${API_BASE}/api/index.php?dev=get-statuses&workflow_id=${currentDocWorkflowId}`),n=await t.json();if("success"===n.status&&n.data.length>0){let t="";n.data.forEach((n=>{n.category!==t&&(""!==t&&(e+="</optgroup>"),e+=`<optgroup label="${n.category}">`,t=n.category),e+=`<option value="${n.status_name}">${n.status_name}</option>`})),""!==t&&(e+="</optgroup>")}else e='<option value="Received">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option><option value="Sent">‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</option>'}catch(t){console.error("Fetch Status Error:",t),e='<option value="Received">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option><option value="Sent">‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</option>'}const{value:t}=await Swal.fire({title:"‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",html:`<label class="form-label text-start w-100">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label><select id="swal-status" class="form-select mb-3">${e}</select><label class="form-label text-start w-100">*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label><input id="swal-receiver" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏">`,focusConfirm:!1,showCancelButton:!0,confirmButtonText:"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",confirmButtonColor:"#00C853",preConfirm:()=>[document.getElementById("swal-status").value,document.getElementById("swal-receiver").value]});if(t){const[n,a]=t,r={doc_code:currentDocCode,status:n,receiver_name:a,line_user_id:userProfile.userId,display_name:userProfile.displayName,picture_url:userProfile.pictureUrl,device_info:liff.getOS()};await fetch(`${API_BASE}/api/index.php?dev=update-status`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),Swal.fire({title:"‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",text:"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",icon:"success",timer:1500,showConfirmButton:!1}).then((()=>{closeDetail()}))}}document.addEventListener("DOMContentLoaded",(function(){var e=document.getElementById("btn-scan");e&&e.addEventListener("click",openLineScanner);var t=document.getElementById("btn-search");t&&t.addEventListener("click",searchDocs);var n=document.getElementById("btn-close-detail");n&&n.addEventListener("click",closeDetail);var a=document.getElementById("btn-open-update");a&&a.addEventListener("click",openUpdateModal);var r=document.getElementById("tab-btn-scan");r&&r.addEventListener("click",(function(){switchTab("scan")}));var i=document.getElementById("tab-btn-search");i&&i.addEventListener("click",(function(){switchTab("search")}));var c=document.getElementById("tab-btn-history");c&&c.addEventListener("click",(function(){switchTab("history")})),main()}));